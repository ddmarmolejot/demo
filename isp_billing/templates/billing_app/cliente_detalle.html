{% extends 'base.html' %}

{% block content %}
<div class="row align-items-center mb-4">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1 small">
                <li class="breadcrumb-item"><a href="{% url 'index' %}">Clientes</a></li>
                <li class="breadcrumb-item active">{{ cliente.apellidos }}, {{ cliente.nombres }}</li>
            </ol>
        </nav>
        <h2 class="fw-bold mb-0">{{ cliente.apellidos }}, {{ cliente.nombres }}</h2>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-outline-primary" onclick="window.location.reload()"><i
                class="fas fa-sync-alt"></i></button>
        <a href="{% url 'cliente-editar' cliente.pk %}" class="btn btn-warning ms-2 shadow-sm">
            <i class="fas fa-edit me-2"></i>Editar Datos
        </a>
        {% if can_delete_cliente %}
        <form method="post" action="{% url 'cliente-eliminar' cliente.pk %}" class="d-inline"
            onsubmit="return confirm('¿Eliminar este cliente? Esta acción no se puede deshacer.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger ms-2 shadow-sm">
                <i class="fas fa-trash-alt me-2"></i>Eliminar Cliente
            </button>
        </form>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Lateral Izquierdo -->
    <div class="col-md-4">
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
                <span><i class="fas fa-info-circle me-2 text-info"></i>Información Personal</span>
                {% if cliente.estado_activo %}
                <span class="badge bg-success">ACTIVO</span>
                {% else %}
                <span class="badge bg-danger">INACTIVO</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="text-muted small text-uppercase fw-bold">DNI</label>
                    <div class="fs-5 fw-bold">{{ cliente.dni }}</div>
                </div>
                <div class="mb-3">
                    <label class="text-muted small text-uppercase fw-bold">Contacto</label>
                    <div class="fs-5 text-primary fw-bold">
                        <i class="fab fa-whatsapp text-success me-1"></i>{{ cliente.celular }}
                    </div>
                </div>
                <div class="mb-3">
                    <label class="text-muted small text-uppercase fw-bold">Dirección</label>
                    <div class="small fw-bold">
                        {{ cliente.via.get_tipo_display }} {{ cliente.via.nombre }}
                        {% if cliente.referencia %}
                        , {{ cliente.referencia }}
                        {% endif %}
                    </div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    {% if cliente.estado_activo %}
                    <form method="post" action="{% url 'cliente-status-toggle' cliente.pk %}" class="d-inline"
                        onsubmit="return confirm('Eliminar esta OT? Esta accion no se puede deshacer.');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="fas fa-user-slash me-2"></i>DESACTIVAR CLIENTE
                        </button>
                    </form>
                    {% else %}
                    <form method="post" action="{% url 'cliente-status-toggle' cliente.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-user-check me-2"></i>REACTIVAR CLIENTE
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 bg-light bg-opacity-50">
            <div class="card-body">
                <h6 class="fw-bold mb-3"><i class="fas fa-network-wired me-2"></i>Configuración Técnica</h6>
                <div class="mb-2">
                    <span class="text-muted small">Tipo:</span> <strong>{{ cliente.tipo_conexion }}</strong>
                </div>
                <div class="mb-3">
                    <span class="text-muted small">Usuario/ID:</span>
                    <code>{{ cliente.usuario_pppoe|default:"-" }}</code>
                </div>
                <div class="mb-3">
                    <span class="text-muted small">IP:</span>
                    <a href="http://{{ cliente.ip_asignada }}" target="_blank" class="text-decoration-none fw-bold">
                        <i class="fas fa-external-link-alt me-1 small"></i>{{ cliente.ip_asignada|default:"0.0.0.0" }}
                    </a>
                </div>

                <hr class="my-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="small text-muted">Nodo Router:</span>
                    <span class="badge bg-primary px-3">
                        {{ cliente.mikrotik_vinculado.nombre|default:"Sin Vincular" }}
                    </span>
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold small">Trafico PPPoE</span>
                            <span class="badge {% if mikrotik_connected %}bg-success{% else %}bg-secondary{% endif %}">
                                {% if mikrotik_connected %}Conectado{% else %}Sin conectar{% endif %}
                            </span>
                        </div>
                        {% if mikrotik_id %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="small text-muted">
                                Usuario: <strong>{{ cliente.usuario_pppoe|default:'-' }}</strong>
                            </div>
                            <button class="btn btn-outline-primary btn-sm" type="button" id="btnTraffic"
                                data-traffic-url="{% url 'mikrotik-traffic' mikrotik_id %}">
                                Actualizar
                            </button>
                        </div>
                        <div class="small text-muted" id="trafficStatus">IP: {{ cliente.ip_asignada|default:'-' }}</div>
                        <div class="small mt-2" id="trafficResult" style="white-space: pre-line;"></div>
                        {% else %}
                        <div class="text-muted small">Cliente sin Mikrotik vinculado.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel Central -->
    <div class="col-md-8">
        <!-- Planes -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-wifi me-2 text-primary"></i>Planes Contratados</h6>
                <button type="button" class="btn btn-sm btn-success shadow-sm btn-open-panel" data-title="Añadir Plan"
                    data-id="{{ cliente.pk }}" data-url="{% url 'cliente-agregar-plan' cliente.pk %}">
                    <i class="fas fa-plus me-1"></i>Añadir Nuevo Plan
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light small">
                        <tr>
                            <th>Plan</th>
                            <th>Mensualidad</th>
                            <th>Día de Pago</th>
                            <th class="text-center">Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cp in cliente.planes.all %}
                        <tr>
                            <td>{{ cp.plan.nombre }}</td>
                            <td class="fw-bold text-success">S/ {{ cp.plan.precio }}</td>
                            <td>{{ cp.fecha_cobranza }} de cada mes</td>
                            <td class="text-center">
                                {% if cp.activo %}
                                <span class="badge bg-success bg-opacity-10 text-success border border-success">Activo</span>
                                {% else %}
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary">Inactivo</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button type="button"
                                    class="btn btn-sm btn-outline-primary btn-open-panel me-1"
                                    data-title="Editar Plan"
                                    data-url="{% url 'cliente-plan-editar' cliente.pk cp.pk %}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="post" action="{% url 'cliente-plan-eliminar' cliente.pk cp.pk %}"
                                    class="d-inline"
                                    onsubmit="return confirm('¿Eliminar este plan? Esta acción no se puede deshacer.');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">Sin planes.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if can_view_deuda %}
        <!-- Cuentas por Cobrar -->
        <div class="card shadow-sm mb-4 border-0 border-start border-4 border-danger">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h6 class="mb-0 fw-bold text-danger">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Estado de Cuenta (Deuda)
                </h6>
                {% if total_deuda > 0 and can_cobrar %}
                <button class="btn btn-sm btn-danger btn-pagar shadow-sm fw-bold px-3" data-id="{{ cliente.pk }}">
                    <i class="fas fa-cash-register me-2"></i>REALIZAR PAGO
                </button>
                {% endif %}
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead class="bg-light small">
                        <tr>
                            <th class="ps-3">Concepto / Mes</th>
                            <th>Original</th>
                            <th>Pagado</th>
                            <th class="text-danger">Saldo</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in deuda %}
                        <tr class="table-danger border-white align-middle">
                            <td class="ps-3">
                                <div class="fw-bold">{{ item.plan_nombre }}</div>
                                <small class="text-muted text-uppercase">{{ item.mes_nombre }}</small>
                            </td>
                            <td>S/ {{ item.monto_original|floatformat:2 }}</td>
                            <td>S/ {{ item.pagado|floatformat:2 }}</td>
                            <td class="fw-bold">S/ {{ item.saldo|floatformat:2 }}</td>
                            <td class="text-center">
                                <form method="post" action="{% url 'cliente-deuda-eliminar' cliente.pk %}"
                                    onsubmit="return confirm('¿Eliminar este concepto de la deuda?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="tipo" value="{{ item.tipo|upper }}">
                                    <input type="hidden" name="plan_id" value="{{ item.id }}">
                                    <input type="hidden" name="mes_iso"
                                        value="{% if item.mes %}{{ item.mes|date:'Y-m-d' }}{% endif %}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-success fw-bold">
                                <i class="fas fa-check-circle me-2"></i>¡CLIENTE AL DIA!
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if total_deuda > 0 %}
                    <tfoot class="bg-light fw-bold">
                        <tr>
                            <td colspan="4" class="text-end pe-3">DEUDA TOTAL:</td>
                            <td class="fs-5 text-danger">S/ {{ total_deuda|floatformat:2 }}</td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Pagos realizados -->
        <div class="card shadow-sm mb-4 border-0 border-start border-4 border-primary">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-receipt me-2 text-primary"></i>Pagos realizados</h6>
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead class="bg-light sticky-top small">
                        <tr>
                            <th class="ps-3">Fecha</th>
                            <th>Documento</th>
                            <th>Importe</th>
                            <th class="text-center">Print</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in cliente.pagos.all|dictsortreversed:"fecha" %}
                        <tr>
                            <td class="ps-3 small">{{ pago.fecha|date:"d/m/Y H:i" }}</td>
                            <td>
                                <span class="badge bg-light text-dark fw-bold border">
                                    {{ pago.tipo_comprobante }} {{ pago.serie_numero }}
                                </span>
                            </td>
                            <td class="fw-bold">S/ {{ pago.monto }}</td>
                            <td class="text-center">
                                <a href="{% url 'pago-pdf' pago.id %}" target="_blank"
                                    class="btn btn-link text-dark p-0">
                                    <i class="fas fa-print"></i>
                                </a>
                            </td>
                            <td class="text-center">
                                <form method="post" action="{% url 'pago-eliminar' pago.id %}"
                                    onsubmit="return confirm('¿Eliminar este pago? Se liberará el número de comprobante.');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-3 text-muted">Sin movimientos.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- OT -->
        <div class="card shadow-sm mb-4 border-0 border-start border-4 border-warning">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-tools me-2 text-warning"></i>Ordenes Técnicas</h6>
                <button type="button" class="btn btn-sm btn-warning shadow-sm btn-open-panel"
                    data-title="Nueva OT" data-url="{% url 'cliente-crear-ot' cliente.pk %}">
                    <i class="fas fa-plus me-1"></i>Nueva OT
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead class="bg-light small">
                        <tr>
                            <th class="ps-3">ID</th>
                            <th>Trabajo</th>
                            <th>Técnico</th>
                            <th>Fecha / Hora trabajo</th>
                            <th>Estado</th>
                            <th>Pago</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ot in ots %}
                        <tr>
                            <td class="ps-3">#{{ ot.id }}</td>
                            <td>
                                {% if ot.concepto.categoria == 'INSTALACION' and ot.observaciones %}
                                <div>{{ ot.observaciones }}</div>
                                <small class="text-muted">{{ ot.concepto.nombre }}</small>
                                {% else %}
                                <div>{{ ot.concepto.nombre }}</div>
                                {% if ot.observaciones %}
                                <small class="text-muted">{{ ot.observaciones }}</small>
                                {% endif %}
                                {% endif %}
                            </td>
                            <td><small class="text-muted">{{ ot.tecnico_asignado.nombre|default:"Sin asignar" }}</small>
                            </td>
                            <td class="small">
                                {% if ot.fecha_finalizacion %}
                                {{ ot.fecha_finalizacion|date:"d/m/Y H:i" }}
                                {% else %}
                                —
                                {% endif %}
                            </td>
                            <td>
                                {% if ot.completada %}
                                <span class="badge bg-success">Listo</span>
                                {% else %}
                                <a href="{% url 'ot-completar' ot.pk %}"
                                    class="badge bg-secondary text-decoration-none">
                                    Pendiente <i class="fas fa-check ms-1"></i>
                                </a>
                                {% endif %}
                            </td>
                            <td>
                                {% if ot.exonerada %}
                                <span class="badge bg-warning text-dark">Exonerada</span>
                                {% elif ot.pagada %}
                                <span class="badge bg-success">Pagado</span>
                                {% else %}
                                <span class="badge bg-danger">Deuda</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <form method="post" action="{% url 'ot-eliminar' ot.pk %}"
                                    onsubmit="return confirm('Eliminar esta OT? Esta accion no se puede deshacer.');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-3 text-muted">Aún no registra OTs.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>

        <!-- Historial de movimientos -->
        <div class="card shadow-sm mb-4 border-0 border-start border-4 border-info">
            <div class="card-header bg-white py-3 fw-bold">
                <i class="fas fa-stream me-2 text-info"></i>Historial de movimientos
            </div>
            <div class="table-responsive" style="max-height: 320px;">
                <table class="table table-sm table-hover align-middle mb-0">
                    <thead class="bg-light sticky-top small">
                        <tr>
                            <th class="ps-3">Fecha</th>
                            <th>Tipo</th>
                            <th>Detalle</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ev in historial %}
                        <tr>
                            <td class="ps-3 small">
                                {{ ev.fecha|date:"d/m/Y" }}
                                {% if ev.fecha_dt and ev.tipo != 'plan' %}
                                {{ ev.fecha_dt|time:"H:i" }}
                                {% endif %}
                            </td>
                            <td>
                                <span
                                    class="badge bg-{{ ev.clase }} bg-opacity-25 text-dark border border-{{ ev.clase }}">
                                    <i class="fas {{ ev.icono }} me-1"></i>{{ ev.titulo }}
                                </span>
                            </td>
                            <td class="small">{{ ev.detalle }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center py-4 text-muted">Sin movimientos registrados.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btnTraffic = document.getElementById('btnTraffic');
        if (btnTraffic) {
            btnTraffic.addEventListener('click', async () => {
                const url = btnTraffic.getAttribute('data-traffic-url');
                const username = '{{ cliente.usuario_pppoe|default:"" }}';
                const result = document.getElementById('trafficResult');
                const status = document.getElementById('trafficStatus');
                if (result) result.textContent = 'Consultando...';

                if (!username) {
                    if (result) result.textContent = 'Cliente sin usuario PPPoE.';
                    return;
                }

                const body = new URLSearchParams();
                body.append('username', username);
                const csrf = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrf
                    },
                    body: body.toString()
                });
                const data = await response.json();
                if (!data.ok) {
                    if (result) result.textContent = data.error || 'Sin datos.';
                    return;
                }
                if (!data.rows || !data.rows.length) {
                    if (result) result.textContent = 'No hay sesiones activas.';
                    return;
                }
                const lines = data.rows.map(row => {
                    return `${row.name} | ${row.profile} | ${row.address} | ${row.uptime} | RX ${row.bytes_in} | TX ${row.bytes_out}`;
                });
                if (result) result.textContent = lines.join('\n');
                if (status && data.rows[0]) {
                    status.textContent = data.rows[0].address || '-';
                }
            });
        }
    });

</script>
{% endblock %}
