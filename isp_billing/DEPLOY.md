# Deployment Guide

This guide explains how to deploy the **isp_billing** Django application to [Render](https://render.com) and obtain a public URL.

## Project layout

```
isp_billing/          ← root directory for deployment
├── manage.py
├── requirements.txt
├── Procfile
├── isp_billing/
│   ├── settings.py
│   ├── wsgi.py
│   └── urls.py
└── billing_app/
```

## Quick deploy with Render Blueprint

The repository already contains a `render.yaml` at the repo root that provisions:

- A **web service** running gunicorn
- A **PostgreSQL database** (free plan) — data persists between deploys via Render Managed Postgres

Steps:

1. Fork or push this repository to your GitHub account.
2. Go to <https://dashboard.render.com/> → **New** → **Blueprint**.
3. Connect your GitHub repository.
4. Render will detect `render.yaml` and pre-fill all settings. Click **Apply**.
5. Wait for the build to finish — your public URL will appear as `https://<service-name>.onrender.com`.

## Manual deploy on Render

If you prefer to configure the service manually:

| Setting | Value |
|---|---|
| **Root Directory** | `isp_billing` |
| **Runtime** | Python 3 |
| **Build Command** | `pip install -r requirements.txt && python manage.py collectstatic --noinput && python manage.py migrate && python manage.py ensure_superuser` |
| **Start Command** | `gunicorn isp_billing.wsgi:application` |

## Database — Render Managed Postgres

The `render.yaml` blueprint automatically creates a **Render Managed PostgreSQL** instance named `isp-billing-db` and sets `DATABASE_URL` on the web service.  Data is stored in Postgres and persists across deploys and restarts.

If you provision the database manually:

1. In the Render dashboard create a new **PostgreSQL** service.
2. Copy the **Internal Database URL** (or External URL for local testing).
3. Add it as the `DATABASE_URL` environment variable on your web service.

The Django settings will automatically detect `DATABASE_URL` and use Postgres; otherwise it falls back to SQLite for local development.

## Required environment variables

| Variable | Description | Example |
|---|---|---|
| `DJANGO_SECRET_KEY` | Long random secret key | auto-generated by Render Blueprint |
| `DEBUG` | Enable debug mode | `False` (production) |
| `ALLOWED_HOSTS` | Comma-separated allowed hostnames | `.onrender.com` |
| `CSRF_TRUSTED_ORIGINS` | Comma-separated trusted origins | `https://*.onrender.com` |
| `DATABASE_URL` | PostgreSQL connection string | set automatically by Render Blueprint |

## Automated superuser creation

The build command runs `python manage.py ensure_superuser` after migrations.  
Set the following environment variables **before the first deploy** (or in the Render dashboard under *Environment*):

| Variable | Description | Example |
|---|---|---|
| `DJANGO_SUPERUSER_USERNAME` | Admin username | `admin` |
| `DJANGO_SUPERUSER_EMAIL` | Admin e-mail (optional) | `admin@example.com` |
| `DJANGO_SUPERUSER_PASSWORD` | Admin password | a strong password |

The command is **idempotent**: if the superuser already exists it does nothing.  
If the variables are not set the command prints a warning and exits without error.

After the first successful deploy you can access `/admin/` with those credentials and create additional application users from there.

## Local development

```bash
cd isp_billing
pip install -r requirements.txt
python manage.py migrate
python manage.py ensure_superuser   # optional: set env vars first
python manage.py runserver
```

## Verify gunicorn locally

```bash
cd isp_billing
gunicorn isp_billing.wsgi:application
```

## Collect static files (CI / build step)

```bash
cd isp_billing
python manage.py collectstatic --noinput
```

Static files are served by [WhiteNoise](https://whitenoise.readthedocs.io/) — no separate static file hosting required.
